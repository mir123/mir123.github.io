<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <title>Improved tapered rivers in QGIS</title>
    <meta name="author" content="Mir Rodriguez Lombardo" />
    <base href="">
    <link rel="stylesheet" type="text/css" href="/theme/tufte-css/tufte.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="/theme/css/main.css" />
    <!--
  Original link to favicon
  <link rel="shortcut icon" type="text/css" href="/favicon.ico" />
  -->
    <link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png" />
    <link rel="shortcut icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" href="/favicon.png" />
    <link rel="mask-icon" href="/favicon.svg" color="black" />  
    <!-- Script para comentarios y feedback -->

    <script src="/js/formchecks.js"></script>

    <!-- OpenGraph Info -->
  <meta property="og:title" content="Improved tapered rivers in QGIS" />
  <meta property="og:type" content="article" />
  <meta property="twitter:card" content="summary" />
  <meta property="twitter:title" content="Improved tapered rivers in QGIS" />
  <meta property="og:image" content="http://mirrodriguezlombardo.com/images/rios_afilados_th_tw.jpg" />
  <meta property="twitter:image" content="http://mirrodriguezlombardo.com/images/rios_afilados_th_tw.jpg" />
  <meta property="og:url" content="rios-afilados-qgis-en.html" />
  <meta property="og:description" content="Here&#39;s a way of making maps of river systems that represent in a much more realistic way the characteristics of a watershed, showing the rank of each river and creek with stroke widths and using tapered lines." />
  <meta property="twitter:description" content="Here&#39;s a way of making maps of river systems that represent in a much more realistic way the characteristics of a watershed, showing the rank of each river and creek with stroke widths and using tapered lines." />
  <meta property="og:locale" content="utf8" />
  <meta property="og:site_name" content="Mir Rodriguez Lombardo" />
  <meta property="article:published_time" content="2019-12-03" />
  <meta property="twitter:site:id" content="@mir_lentejas" />
  <meta property="article:section" content="Cartography" />
  <meta property="article:tag" content="maps" />
  <meta property="article:tag" content="cartography" />
  <meta property="article:tag" content="rivers" />
  <meta property="article:tag" content="tapered" />
  <meta property="article:tag" content="lines" />
  <meta property="article:tag" content="qgis" />
  <meta property="article:tag" content="hydrography" />
 </head>

<body>

    <header>
        <h1 class="websitetitle"><a href="/">Mir Rodriguez Lombardo</a></h1>
        <nav class="navmenu" id="navmenu">
            <li><a class="navitemlink" href="/archives.html">Notas</a></li>
                       <li><a class="navitemlink" href="/pages/bio.html">Hoja de vida </a></li>
                <li><a class="navitemlink" href="/pages/cartografia.html">Cartografía </a></li>
                <li><a class="navitemlink" href="/pages/web.html">Web </a></li>
                <li><a class="navitemlink" href="/pages/traduccion.html">Traducción </a></li>
                <li><a class="navitemlink" href="/pages/almanaque.html">Almanaque Azul </a></li>
                <li><a class="navitemlink" href="/pages/el-mar.html">El mar </a></li>
                <li><a class="navitemlink" href="/pages/contacto.html">Contacto </a></li>
          </nav>
    </header>

 
<script type="text/javascript">
function checkForm() {
name = document.getElementById("name").value;
email = document.getElementById("email").value;
comment = document.getElementById("comment").value;

if (name == "")
{
hideAllErrors();
document.getElementById("nameError").style.display = "inline";
document.getElementById("name").select();
document.getElementById("name").focus();
return false;
}
else if (email == "")
{
hideAllErrors();
document.getElementById("emailError").style.display = "inline";
document.getElementById("email").select();
document.getElementById("email").focus();
return false;
}
else if (comment == "")
{
hideAllErrors();
document.getElementById("commentError").style.display = "inline";
document.getElementById("comment").select();
document.getElementById("comment").focus();
return false;
}
if (!checkEmail(email))
{
alert('Email address is invalid');
return false;
}
return true;
}
 
function hideAllErrors() {
document.getElementById("nameError").style.display = "none";
document.getElementById("emailError").style.display = "none";
document.getElementById("commentError").style.display = "none";
}
 
function checkEmail(inputvalue) {
var pattern = /^([a-zA-Z0-9_.-])+@(([a-zA-Z0-9-])+.)+([a-zA-Z0-9]{2,4})+$/;
return pattern.test(inputvalue);
}
</script>

<article>
	<section>

<header class="post-header">
<h1> <a rel="bookmark"
   title="Improved tapered rivers in QGIS «Mir Rodriguez Lombardo»"
   href="rios-afilados-qgis-en.html">
   Improved tapered rivers in QGIS
</a>
 <h3>
<a href="/rios-afilados-qgis.html" hreflang="es">
(versión en español aquí
</a>)

</h1>
<p class="subtitle"><time datetime="2019-12-03T21:30:00-06:00">03 Dec 2019</time><br />
<!--  #<a href="/tag/maps.html">maps</a> #<a href="/tag/cartography.html">cartography</a> #<a href="/tag/rivers.html">rivers</a> #<a href="/tag/tapered.html">tapered</a> #<a href="/tag/lines.html">lines</a> #<a href="/tag/qgis.html">qgis</a> #<a href="/tag/hydrography.html">hydrography</a> -->
</span></p>




</header><p class="newsection"><span class="newthought">Here's a way</span> of making maps of river systems in QGIS that represent in a much more realistic way the characteristics of a watershed, showing the rank of each river and creek with stroke widths and using tapered lines. Watersheds drawn in this way represent much better the relative flows of streams and add an additional graphic element to show the direction of flow of water bodies.</p>

<p><img alt="Map of the watersheds of the Sansón and Sansoncito rivers in Darien, Panama." src="/images/rios_afilados_th1.jpg"></p>
<p>This is an improvement of the method proposed by Anita Graser (author of “QGIS map design”) in her <a href="https://anitagraser.com/2017/04/17/better-river-styles-with-tapered-lines/">blog</a>. </p>
<p>You will of course need a decent river data set. In my case I have used the rivers from the new 1:25,000 maps of the Panamanian geographic institute<label for="igntg" class="margin-toggle sidenote-number"></label><input type="checkbox" id="igntg" class="margin-toggle"/><span class="sidenote">The Instituto Geográfico Nacional Tommy Guardia”, IGNTG</span>. The IGNTG has not released the data layers of the new maps, so I have been forced to digitize the rivers on top of a georeferenced PDF like this one: </p>
<p><img alt="Detail of a Tommy Guardia map." src="/images/detalle_4641IIISE.png"></p>
<p>You can also do this with satellite or drone images. Make sure your data meets some minimal criteria:</p>
<ol>
<li>Each river and creek must be on a single feature. If the river is made up of more than one line, you must join these lines in order to end up with a single one. I won't go into details here but you can try to do this by selecting all your segments and using <em>Vector/Geoprocessing tools/Dissolve</em>. The map shown here has this problem in one of the rivers, let's see if you can spot it.</li>
<li>The line should be drawn from the source to the mouth, meaning in a downstream direction. Or at least all in the same direction. The line direction is important for the algorithm used here to know where to start plotting the thinnest part of the line and the gradual thickening of the stream. When you have a river that looks like the image here<label for="sn-demo" class="margin-toggle">&#8853;</label><input type="checkbox" id="invertido" class="margin-toggle"/><span class="marginnote"><img alt="How a river looks if drawn in inverted direction" src="/images/rio_inverso.jpg">This creek's direction needs to be fixed</span>, fix it by selecting your river and clicking on <em>Reverse line</em> in the <em>Advanced digitizing</em> toolbar.</li>
<li>You must include in your attribute table a column that represents the rank of each stream. In the example layer in here, this field is called <code>"AA_ORDEN"</code>. The largest rivers are have the order 0, those that drain into the largest rivers are 1 and so on. I used 6 levels, 0 to 5, number 5 is for the smallest creeks. You can see the numbers I used for streams on my map here:
 <img alt="Value of the &quot;AA_ORDEN&quot; field in my rivers dataset." src="/images/rios_orden_rios.jpg">
 You can come up with your own classification system: 'large river', 'small stream', 'mid-size river' or whatever you want.
 You may want to adjust these values by trial and error based on how it looks. </li>
<li>Depending on the scale of your map, you should include as many nodes as possible on each line. The more detail you add to your streams the better it will look, since the code thickens the line segment by segment.</li>
<li>You may want to add a column with the name of the watershed the stream belongs to. With this you will have the option of showing a specific watershed on your map using different colors or showing all the streams in your watershed of interest and only the largest ones in the other watersheds.</li>
</ol>
<p>I include here a sample dataset you can use for experimenting. It includes the streams of the Sansón and Sansoncito watersheds in the Darien Province in Panama. The CRS is WGS 84/UTM 18N (EPSG 32618).</p>
<p><strong>Download the sample dataset here</strong> in <a href="/capas/cuenca_rios_sanson_sansoncito_panama.gpkg">geopackage</a> or <a href="/capas/cuenca_rios_sanson_sansoncito_panama_shp.zip">shapefile</a> format.</p>
<p>Once you have your rivers dataset we are ready to begin.</p>
<p><strong>Note:</strong> this method uses quite a bit of CPU, especially with longer rivers and if your dataset is large and detailed. If you are using QGIS in an underpowered computer, be ready for it to get warm and maybe take a long time to render your streams.<label for="caparapida" class="margin-toggle sidenote-number"></label><input type="checkbox" id="caparapida" class="margin-toggle"/><span class="sidenote">It is a good idea to make a duplicate layer with simple symbology to visualize your data quickly and only show your tapered river later when necessary.</span></p>
<ol>
<li>Add your layer.</li>
<li>From the <em>Layer properties/Symbology</em> dialog, add a <em>Geometry generator</em> symbol layer with the Geometry type <em>Linestring/MultiLinestring</em>. In the box for the expression type <code>segments_to_lines($geometry)</code>
 <img alt="" src="/images/rios_geometry_generator.jpg"></li>
<li>Select the <em>Simple line</em> layer in the same dialog and choose your stroke color.
 <img alt="" src="/images/rios_single_line_dialog.jpg">
 In the Stroke width field, select <em>Meters at scale</em> (this is what I used here, you can also use milimeters or whatever you want). The actual width in the text box here makes no difference, as we will generate it as follows. Click on  <em>Data defined override</em> (the icon on the right side) and choose <em>Edit...</em>. 
 <img alt="" src="/images/rios_stroke_width.jpg">
In the <em>Expression string builder</em> dialog that appears, copy the following code:</li>
</ol>
<div class="highlight"><pre><span></span><span class="w"> </span><span class="k">CASE</span><span class="w"> </span>
<span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="ss">&quot;AA_ORDEN&quot;</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="ss">&quot;AA_ORDEN&quot;</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="ss">&quot;AA_ORDEN&quot;</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="mi">3</span><span class="w"></span>
<span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="ss">&quot;AA_ORDEN&quot;</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="mf">3.5</span><span class="w"></span>
<span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="ss">&quot;AA_ORDEN&quot;</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="mi">5</span><span class="w"></span>
<span class="w"> </span><span class="k">ELSE</span><span class="w"> </span><span class="mi">10</span><span class="w"></span>
<span class="w"> </span><span class="k">END</span><span class="w"> </span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="w">  </span><span class="nf">log10</span><span class="p">(</span><span class="nv">@geometry_part_num</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w">  </span><span class="nf">log10</span><span class="p">(</span><span class="nv">@geometry_part_count</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">log10</span><span class="p">(</span><span class="err">$</span><span class="n">length</span><span class="p">)</span><span class="w"> </span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3</span><span class="w"></span>
</pre></div>


<p><img alt="" src="/images/rios_expression_builder.jpg"></p>
<p>Let's take a look at the code. Your stream rank column, the one I describe in point 3 above, is the one I've called <code>"AA_ORDEN"</code>. Replace this in the code here with the name of your rank column. The number that follows, ( <code>= 5</code>, <code>= 4</code> etc) is the classifier you used for your streams, from the smallest creek (5) to the largest rivers (0, the zero is not shown because it is selected by the <code>ELSE</code>). Put here whatever you used to rank your streams (for example, <code>= 'big river'</code> or <code>= 'tiny stream'</code>). </p>
<p>The numbers after <code>THEN</code> (<code>1</code>, <code>2</code>, <code>3</code>, <code>3.5</code>, <code>5</code> and the <code>10</code> in the <code>ELSE</code>) represent the width of your line. Since we chose <em>Meters at scale</em> before, this number is the width of your river in meters. You can adjust these figures according to the real width of streams of to how they look better. If you used millimeters, these values would be different.</p>
<p>The following section of the code does the magic of the tapered rivers. It uses the expressions <code>@geometry_part_num</code>, <code>@geometry_part_count</code> and <code>$length</code> to asign progressively thicker values to each segment of your line, making it wider the longer your line is.<label for="log10" class="margin-toggle sidenote-number"></label><input type="checkbox" id="log10" class="margin-toggle"/><span class="sidenote">I've used a logarithmic function (<code>log10</code>) so that width increases rapidly at the beginning of the stream and then increases more slowly. It seems to me longer rivers look better this way. You can change this part of the code and use <br/><br/><code>* (  @geometry_part_num /  @geometry_part_count )</code><br/><br/>if you prefer your lines to become wider more gradually. Try both options to see which one you like better.</span></p>
<p>The last section, <code>* 3</code>, is an additional factor you can use if you want all of your rivers to be wider (multiply by a number larger than 1) or thinner (less than 1, like 0.5, for example). This factor and the width values are something you want to adjust by trial and error.</p>
<p>Check <a href="/images/rios_afilados.png">here</a> the final result in high resolution. </p>
<p>This method requires a bit more work preparing your dataset and then time to adjust the width values in the expression. But the result is worth it and your map will look much better. Share your modifications to this method and your resulting maps leaving a comment below, on <a href="https://twitter.com/mir_lentejas/status/1201950941026672641">Twitter</a> or <a href="https://www.reddit.com/r/QGIS/comments/e5ukog/my_tutorial_on_making_watershed_maps_with_qgis/">Reddit</a>, I'd love to hear your thoughts and ideas.</p>
<h2>Comments</h2>
<p><em><p class="newsection">Comments are moderated before they are published.</p></em></p>
<script language="JavaScript">
var username = "mir.rodriguez";
var hostname = "guineo.org";
var linktext = username + "@" + hostname ;
document.write("<form onsubmit='return checkForm();' action='http://formspree.io/" + username + "@" + hostname + "' method='POST'>");
</script>

<div class="nombre">
<input type="text" id="name" name="name" placeholder="NAME" aria-label="Name"><br/>
<div class="error" id="nameError">You must include your name<br /></div>
</div>

<div class="contact_email">
<input type="email" id="email" name="_replyto" placeholder="EMAIL" aria-label="Email"><br/>
<div class="error" id="emailError">I need your email address, it won't be published<br /></div>
</div>

<div class="contact_comment">
<textarea name="body" id="comment" placeholder="COMMENT" aria-label="Message" rows="5"></textarea><br/>
<div class="error" id="commentError">Please write a comment<br /></div>
<input type="hidden" name="_format" value="plain" />
<input type="hidden" name="_language" value="en" />
</div>

<p><button type="submit" style="margin-left: -1.5em;" value="SUBMIT">NEXT &gt;</button>
</form> </p>
<p class="newsection">You can also comment on <a href="https://twitter.com/mir_lentejas/status/1201950941026672641">Twitter</a> or <a href="https://www.reddit.com/r/QGIS/comments/e5ukog/my_tutorial_on_making_watershed_maps_with_qgis/">Reddit</a></p>

<hr>
	<section>
</article>
    <footer>
        <header>


            <nav class="navmenu" id="navmenu">

                <li><a class="navitemlink" href="/archives.html">Notas</a></li>
                          <li><a class="navitemlink" href="/pages/bio.html">Hoja de vida</a></li>
                    <li><a class="navitemlink" href="/pages/cartografia.html">Cartografía</a></li>
                    <li><a class="navitemlink" href="/pages/web.html">Web</a></li>
                    <li><a class="navitemlink" href="/pages/traduccion.html">Traducción</a></li>
                    <li><a class="navitemlink" href="/pages/almanaque.html">Almanaque Azul</a></li>
                    <li><a class="navitemlink" href="/pages/el-mar.html">El mar</a></li>
                    <li><a class="navitemlink" href="/pages/contacto.html">Contacto</a></li>
              </nav>
        </header>
        <!-- <p>Powered by <a href="http://pelican.readthedocs.org">Pelican</a></p> -->
    </footer>
</body>

</html>