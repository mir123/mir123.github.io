<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
    <title>Cómo dibujar ríos afilados en QGIS</title>
  <meta name="author" content="Mir Rodriguez Lombardo" />
  <base href="">
  <link rel="stylesheet" type="text/css" href="/theme/tufte-css/tufte.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" type="text/css" href="/theme/css/main.css" /> 
  <!--
  Original link to favicon
  <link rel="shortcut icon" type="text/css" href="/favicon.ico" />
  -->
  <link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png" />
  <link rel="shortcut icon" href="/favicon.ico" />
  <link rel="icon" type="image/png" href="/favicon.png" />
  <link rel="mask-icon" href="/favicon.svg" color="black" />


  <!-- OpenGraph Info -->
  <meta property="og:title" content="Cómo dibujar ríos afilados en QGIS" />
  <meta property="og:type" content="article" />
  <meta property="twitter:card" content="summary" />
  <meta property="twitter:title" content="Cómo dibujar ríos afilados en QGIS" />
  <meta property="og:image" content="http://mirrodriguezlombardo.com/images/rios_afilados_th_tw.jpg" />
  <meta property="twitter:image" content="http://mirrodriguezlombardo.com/images/rios_afilados_th_tw.jpg" />
  <meta property="og:url" content="rios-afilados-qgis.html" />
  <meta property="og:description" content="Aquí explico una manera de hacer mapas de ríos que representan de manera mucho más realista las características de una cuenca, mostrando el rango de cada río y quebrada y dibujando líneas afiladas." />
  <meta property="twitter:description" content="Aquí explico una manera de hacer mapas de ríos que representan de manera mucho más realista las características de una cuenca, mostrando el rango de cada río y quebrada y dibujando líneas afiladas." />
  <meta property="og:locale" content="utf8" />
  <meta property="og:site_name" content="Mir Rodriguez Lombardo" />
  <meta property="article:published_time" content="2019-12-01" />
  <meta property="twitter:site:id" content="@mir_lentejas" />
  <meta property="article:section" content="Cartografía" />
  <meta property="article:tag" content="mapas" />
  <meta property="article:tag" content="cartografía" />
  <meta property="article:tag" content="ríos" />
  <meta property="article:tag" content="afilados" />
  <meta property="article:tag" content="tapered" />
  <meta property="article:tag" content="qgis" />
  <meta property="article:tag" content="hidrografía" />

</head>

<body>

  <header>
    <h1 class="websitetitle"><a href="/">Mir Rodriguez Lombardo</a></h1>
    <nav class="navmenu" id="navmenu">
     <li><a class="navitemlink" href="/archives.html">Notas</a></li>
            <li><a class="navitemlink" href="/pages/bio.html">Hoja de vida </a></li>
            <li><a class="navitemlink" href="/pages/cartografia.html">Cartografía </a></li>
            <li><a class="navitemlink" href="/pages/traduccion.html">Traducción </a></li>
            <li><a class="navitemlink" href="/pages/almanaque.html">Almanaque Azul </a></li>
            <li><a class="navitemlink" href="/pages/el-mar.html">El mar </a></li>
            <li><a class="navitemlink" href="/pages/contacto.html">Contacto </a></li>
     </nav>
   </header>



<script type="text/javascript">
function checkForm() {
name = document.getElementById("name").value;
email = document.getElementById("email").value;
comment = document.getElementById("comment").value;

if (name == "")
{
hideAllErrors();
document.getElementById("nameError").style.display = "inline";
document.getElementById("name").select();
document.getElementById("name").focus();
return false;
}
else if (email == "")
{
hideAllErrors();
document.getElementById("emailError").style.display = "inline";
document.getElementById("email").select();
document.getElementById("email").focus();
return false;
}
else if (comment == "")
{
hideAllErrors();
document.getElementById("commentError").style.display = "inline";
document.getElementById("comment").select();
document.getElementById("comment").focus();
return false;
}
if (!checkEmail(email))
{
alert('Email address is invalid');
return false;
}
return true;
}
 
function hideAllErrors() {
document.getElementById("nameError").style.display = "none";
document.getElementById("emailError").style.display = "none";
document.getElementById("commentError").style.display = "none";
}
 
function checkEmail(inputvalue) {
var pattern = /^([a-zA-Z0-9_.-])+@(([a-zA-Z0-9-])+.)+([a-zA-Z0-9]{2,4})+$/;
return pattern.test(inputvalue);
}
</script>

<article>
	<section>

<header class="post-header">
<h1> <a rel="bookmark"
   title="Cómo dibujar ríos afilados en QGIS «Mir Rodriguez Lombardo»"
   href="rios-afilados-qgis.html">
   Cómo dibujar ríos afilados en QGIS
</a>
</h1>
<p class="subtitle"><time datetime="2019-12-01T10:30:00-06:00">01 dic 2019</time><br />
<!--  #<a href="/tag/mapas.html">mapas</a> #<a href="/tag/cartografia.html">cartografía</a> #<a href="/tag/rios.html">ríos</a> #<a href="/tag/afilados.html">afilados</a> #<a href="/tag/tapered.html">tapered</a> #<a href="/tag/qgis.html">qgis</a> #<a href="/tag/hidrografia.html">hidrografía</a> -->
</span></p>
</header><p class="newsection"><span class="newthought">Aquí explico una manera</span> de hacer mapas de ríos que representan de manera mucho más realista las características de una cuenca, mostrando el rango de cada río y quebrada<label for="quebradas" class="margin-toggle sidenote-number"></label><input type="checkbox" id="quebradas" class="margin-toggle"/><span class="sidenote">En Panamá le llamamos <i>quebradas</i> a los riachuelos o arroyos</span> y dibujando líneas afiladas. Las cuencas hidrográficas trazadas de esta manera reflejan muy bien los caudales relativos y agregan un elemento gráfico adicional para visualizar la dirección del flujo de las aguas.</p>

<p><img alt="Mapa de las cuencas de los ríos Sansón y Sansoncito en Darién, Panamá." src="/images/rios_afilados_th1.jpg"></p>
<p>La técnica es una mejora del método propuesto por Anita Graser (autora de “QGIS map design”) en su <a href="https://anitagraser.com/2017/04/17/better-river-styles-with-tapered-lines/">blog</a>. </p>
<p>Necesitarás, por supuesto, una base de datos de ríos decente. En mi caso, he usado la hidrografía de la nueva cartografía de Panamá en 1:25,000 del Instituto Geográfico Nacional Tommy Guardia (IGNTG). El IGNTG todavía no ha publicado las capas geográficas de la nueva cartografía, así que me he visto obligado a dibujarla directamente sobre mapas PDF georeferenciados, como este: </p>
<p><img alt="Detalle de mapa del Tommy Guardia." src="/images/detalle_4641IIISE.png"></p>
<p>Esto también lo puedes hacer usando imágenes satelitales o fotos aéreas de drones. Te debes asegurar que los datos cumplen con ciertas características mínimas:</p>
<ol>
<li>Cada río y quebrada debe estar representado en un solo elemento. Si el río está dividido en varias líneas, deberás unir estas líneas para que quede una sola. No voy a entrar en detalles aquí, pero puedes intentarlo seleccionando las distintas partes del río y usando <em>Vectorial/Herramientas de geoproceso/Disolver</em>. El mapa que pongo aquí sufre de este problema en uno de sus ríos, a ver si lo encuentras.</li>
<li>La línea de cada río y quebrada debe estar dibujada desde su nacimiento hasta su desembocadura, es decir en dirección río abajo. <label for="sn-demo" class="margin-toggle"></label><input type="checkbox" id="invertido" class="margin-toggle"/><span class="marginnote"><img alt="Imagen de cómo se ve un río dibujado en sentido inverso" src="/images/rio_inverso.jpg">Hace falta invertirle el sentido a esta quebrada</span>O al menos todos en la misma dirección. La dirección de la línea es importante para que el algoritmo usado en el procedimiento que se muestra aquí sepa cómo dibujar la parte delgada y el gradual engrosamiento del cuerpo de agua. De otro modo quedarás con ríos que nacen gruesos y terminan delgados.
 Cuando eso ocurre se verá como aquí al costado, en ese caso selecciona tu río y usa <em>Invertir línea</em> en la barra de herramientas <em>Digitalización avanzada</em> para corregir la dirección de la línea.</li>
<li>Deberás incluir en tu tabla de atributos una columna que represente el rango de cada río y quebrada. En la capa de ejemplo que pongo aquí, este campo se llama <code>"AA_ORDEN"</code>. Los ríos más grandes tendrán el orden 0, los que desembocan en los ríos grandes serán 1 y así. Aquí utilicé 6 niveles, del 0 al 5, el número 5 es para las quebradas más pequeñas en las que no desemboca ninguna otra quebrada, el 4 para las que reciben las aguas de una o dos quebradas y así voy hasta los ríos más grandes con el 0. Aquí puedes ver la clasificación que le di a los ríos en mi mapa:
 <img alt="Valor del campo &quot;AA_ORDEN&quot; en mi capa de ríos." src="/images/rios_orden_rios.jpg">
 Puedes inventar tu propio sistema de clasificación: 'río grande', 'arroyo pequeño', 'río mediano' o como quieras llamarle.<label for="caudal" class="margin-toggle sidenote-number"></label><input type="checkbox" id="caudal" class="margin-toggle"/><span class="sidenote">Si tienes la suerte de contar con datos de caudal de los ríos de tu cuenca puedes utilizar estos datos convirtiéndolos a una distribución de frecuencias.</span> 
 Estos valores los irás ajustando por ensayo y error según cómo se ve, porque al final es un asunto de apariencia visual, con la idea de representar los ríos más grandes con líneas más gruesas y los pequeños más delgados.</li>
<li>Según la escala a la que hagas tu mapa, deberás incluir la mayor cantidad de puntos posibles en cada trayecto. Mientras más detalle pongas en cada río, mejor se verá, ya que el algoritmo va engrosando la línea segmento por segmento.</li>
<li>Si quieres puedes agregar un campo a tu tabla con el nombre de la cuenca a la que pertenece el cuerpo de agua. Esto resulta conveniente para tener la opción de mostrar una cuenca específica en tu mapa, con un color diferente o para mostrar tu cuenca de interés con más detalle y las otras cuencas sólo con los ríos más grandes.</li>
</ol>
<p>Aquí incluyo una capa de ejemplo para que puedas empezar a hacer tus pruebas, la de los ríos Sansón y Sansoncito en la provincia de Darién en Panamá. Esta capa está proyectada en el sistema de coordenadas WGS 84/UTM 18N (EPSG 32618).</p>
<p>(<strong>Baja aquí la capa de ejemplo</strong> en <a href="/capas/cuenca_rios_sanson_sansoncito_panama.gpkg">geopackage</a> o en <a href="/capas/cuenca_rios_sanson_sansoncito_panama_shp.zip">shapefile</a>).</p>
<p>Una vez tengas tu capa de ríos estamos listos para comenzar.</p>
<p><strong>Advertencia:</strong> este método utiliza mucho CPU de tu computadora, especialmente con los ríos más grandes y si tu capa es muy amplia y compleja. Si estás usando QGIS en una laptop con poco poder prepárate para que se caliente y quizá tome un largo tiempo en mostrar tus ríos.<label for="caparapida" class="margin-toggle sidenote-number"></label><input type="checkbox" id="caparapida" class="margin-toggle"/><span class="sidenote">Es una buena idea hacer en QGIS un duplicado de la capa con simbología sencilla que puedas usar para visualizar tus datos de manera rápida y solo actives la capa de ríos afilados cuando sea necesario.</span></p>
<ol>
<li>Abre tus datos</li>
<li>Desde la ventana de <em>Propiedades de la capa/Simbología</em> agrega una capa tipo <em>Generador de geometrías</em> con el Tipo de geometría <em>CadenaDeLínea/CadenaMultiLínea</em>. En el espacio para la expresión, escribe <code>segments_to_lines($geometry)</code>
 <img alt="" src="/images/rios_generador_de_geometrias.jpg"></li>
<li>Al seleccionar <em>CadenaDeLínea/CadenaMultiLínea</em> en la sección <em>Tipo de geometría</em> en la misma ventana aparece una capa <em>Línea sencilla</em>. Selecciona esta capa y elige tu color.
 <img alt="" src="/images/rios_linea_sencilla.jpg">
 En el campo de Anchura de marca selecciona <em>Metros a escala</em> (aunque también puedes usar milímetros u otro tipo de medida). No importa el ancho que pongas aquí, porque lo vamos a generar dinámicamente con el código que pondremos a continuación. Haz clic en <em>Suplantación definida por datos</em> (el ícono que aparece del lado derecho) y elige <em>Editar...</em>. 
 <img alt="" src="/images/rios_anchura_de_marca.jpg">
En la ventana <em>Constructor de cadena de expresión</em>, pon el siguiente código:</li>
</ol>
<div class="highlight"><pre><span></span> <span class="nv">CASE</span> 
 <span class="nv">WHEN</span> <span class="s2">&quot;</span><span class="s">AA_ORDEN</span><span class="s2">&quot;</span>  <span class="o">=</span> <span class="mi">5</span> <span class="k">THEN</span> <span class="mi">1</span>
 <span class="nv">WHEN</span> <span class="s2">&quot;</span><span class="s">AA_ORDEN</span><span class="s2">&quot;</span>  <span class="o">=</span> <span class="mi">4</span> <span class="k">THEN</span> <span class="mi">2</span>
 <span class="nv">WHEN</span> <span class="s2">&quot;</span><span class="s">AA_ORDEN</span><span class="s2">&quot;</span>  <span class="o">=</span> <span class="mi">3</span> <span class="k">THEN</span> <span class="mi">3</span>
 <span class="nv">WHEN</span> <span class="s2">&quot;</span><span class="s">AA_ORDEN</span><span class="s2">&quot;</span>  <span class="o">=</span> <span class="mi">2</span> <span class="k">THEN</span> <span class="mi">3</span>.<span class="mi">5</span>
 <span class="nv">WHEN</span> <span class="s2">&quot;</span><span class="s">AA_ORDEN</span><span class="s2">&quot;</span>  <span class="o">=</span> <span class="mi">1</span> <span class="k">THEN</span> <span class="mi">5</span>
 <span class="k">ELSE</span> <span class="mi">10</span>
 <span class="k">END</span> 
 <span class="o">*</span> <span class="ss">(</span>  <span class="nv">log10</span><span class="ss">(</span>@<span class="nv">geometry_part_num</span><span class="ss">)</span> <span class="o">/</span>  <span class="nv">log10</span><span class="ss">(</span>@<span class="nv">geometry_part_count</span><span class="ss">)</span> <span class="ss">)</span> 
 <span class="o">*</span> <span class="nv">log10</span><span class="ss">(</span>$<span class="nv">length</span><span class="ss">)</span> 
 <span class="o">*</span> <span class="mi">3</span>
</pre></div>


<p><img alt="" src="/images/rios_constructor_de_cadena_de_expresion.jpg"></p>
<p>Vamos a analizar el código. Tu columna de orden de río, la que explico en el punto 3 arriba, es la que yo he llamado <code>"AA_ORDEN"</code>. Reemplaza en el código aquí el nombre de tu columna de orden. El número que aparece a continuación ( <code>= 5</code>, <code>= 4</code> etc) son los números que usaste para calificar las quebradas más pequeñas (5) hasta los ríos más grandes (0, el cero no aparece porque se selecciona con el <code>ELSE</code>). Si usas otra manera de clasificar tus ríos, reemplázalo aquí (por ejemplo, <code>= 'río grande'</code> ó <code>= 'arroyo chico'</code>). </p>
<p>El número que sale después de <code>THEN</code> (<code>1</code>, <code>2</code>, <code>3</code>, <code>3.5</code>, <code>5</code> y el <code>10</code> en el <code>ELSE</code>) es el grosor que tendrá la última parte de tu línea. Como más arriba elegimos <em>Metros a escala</em> este número es el grosor de tu río en metros. Puedes ir ajustando estos valores según la realidad o como mejor se vean. Si usaste milímetros, estos valores serán diferentes.</p>
<p>La siguiente parte del código es la que hace la magia de los ríos afilados. Utiliza las expresiones <code>@geometry_part_num</code>, <code>@geometry_part_count</code> y <code>$length</code> para asignar grosores progresivamente mayores a cada segmento de la línea de tu río, engrosándolo según la longitud del segmento. <label for="log10" class="margin-toggle sidenote-number"></label><input type="checkbox" id="log10" class="margin-toggle"/><span class="sidenote">He usado una función logarítmica (<code>log10</code>) para que el grosor aumente rápidamente al principio del río y luego aumente más gradualmente. Me parece que los ríos más largos se ven mejor así. Puedes modificar esa parte del código y usar<br/><br/><code>* (  @geometry_part_num /  @geometry_part_count )</code><br/><br/>si prefieres que tus líneas se engrosen más gradualmente. Intenta ambas opciones para ver cuál te gusta más. </span></p>
<p>La última parte, <code>* 3</code>, es un factor adicional que puedes utilizar si quieres que todos los ríos se vean más gruesos (multiplica por un valor mayor que 1) o más delgados (menores que 1, como 0.5, por ejemplo). Este factor y los valores de grosor los podrás ir ajustando por ensayo y error.</p>
<p>Puedes descargar el resultado final en alta resolución <a href="/images/rios_afilados.png">aquí</a>. </p>
<p>Este método requiere un poco más de trabajo preparando tu capa y luego tiempo para ajustar los valores de grosor en la expresión. Pero el resultado vale la pena y tu mapa se verá mucho más bonito. Comparte tus modificaciones a este método y tus mapas dejando un comentario abajo o en Twitter, me encantaría escuchar tus ideas.</p>
<h2>Comentarios</h2>
<p><em><p class="newsection">Los comentarios son moderados antes de publicarse.</p></em></p>
<script language="JavaScript">
var username = "mir.rodriguez";
var hostname = "guineo.org";
var linktext = username + "@" + hostname ;
document.write("<form onsubmit='return checkForm();' action='http://formspree.io/" + username + "@" + hostname + "' method='POST'>");
</script>

<div class="nombre">
<input type="text" id="name" name="name" placeholder="NOMBRE" aria-label="Nombre"><br/>
<div class="error" id="nameError">Debes poner tu nombre<br /></div>
</div>

<div class="contact_email">
<input type="email" id="email" name="_replyto" placeholder="EMAIL" aria-label="Email"><br/>
<div class="error" id="emailError">Necesito tu dirección de email<br /></div>
</div>

<div class="contact_comment">
<textarea name="body" id="comment" placeholder="COMENTARIO" aria-label="Mensaje" rows="5"></textarea><br/>
<div class="error" id="commentError">Por favor escribe un comentario<br /></div>
<input type="hidden" name="_format" value="plain" />
<input type="hidden" name="_language" value="es" />
</div>

<p><button type="submit" style="margin-left: -1.5em;" value="ENVIAR">SIGUIENTE &gt;</button>
</form> </p>
<p class="newsection">También puedes <a href="https://twitter.com/mir_lentejas/status/1154075468997517312">comentar vía Twitter</a></p>

<hr>
	<section>
</article>
<footer>
   <header>


  <nav class="navmenu" id="navmenu">

          <li><a class="navitemlink" href="/archives.html">Notas</a></li>
          <li><a class="navitemlink" href="/pages/bio.html">Hoja de vida</a></li>
          <li><a class="navitemlink" href="/pages/cartografia.html">Cartografía</a></li>
          <li><a class="navitemlink" href="/pages/traduccion.html">Traducción</a></li>
          <li><a class="navitemlink" href="/pages/almanaque.html">Almanaque Azul</a></li>
          <li><a class="navitemlink" href="/pages/el-mar.html">El mar</a></li>
          <li><a class="navitemlink" href="/pages/contacto.html">Contacto</a></li>
   </nav>
 </header>
  <!-- <p>Powered by <a href="http://pelican.readthedocs.org">Pelican</a></p> --> 
</footer>
</body>
</html>